# Severe Mental Illness and Social issues in London

```{r warning=FALSE, message=FALSE}
library(sf)
library(tidyverse)
library(tmap)
library(janitor)
library(here)
library(broom)
library(car)
library(cowplot)
library(corrr)
library(sp)
library(spdep)
library(spgwr)
library(spatialreg)
library(readxl)
```

## Project Scope

**Research question**

-   Is there any relationship between CMD(Common Mental Disorders) and social issues such as population density, deprivation, and household composition in London?

**References**
From Dr. Jay's presentation
- Likelihood of CMDs is higher in people living alone, with poor physical health and not in work (APMS 2014).
- Strong association with area deprivation

**Hypothesis**

-   Higher population density and deprivation rate lead to a higher number of SMI patient in London
-   Single household lead the higher number of CMD patient

**Data**

- 

**Analysis**

-   Map SAMHI index across London LSOA
-   Load population density, deprivation, and ethnicity data

- Mental health index echibit Spatial autocorrelation
-   Conduct multiple linear regression with SMI index as the dependent variable and selected social issues as independent variables
-   Experiment with the spatial lag and spatial error models, comparing their results
-   Run geographically weighted regression (GWR) to see if there is local variation that is not captured by the global model

**Assumptions**


## Data

[Statistical GIS Boundary Files for London](https://data.london.gov.uk/dataset/statistical-gis-boundary-files-london)

-   This data contains various GIS boundary files for London at different spatial aggregation units, including Lower Super Output Area (LSOA), Middle Super Output Area (MSOA), Wards and Boroughs.
-   For this analysis, we will use LSOA data so that the spatial units correspond with the data available on SMI index
-   Transform the data to a projected coordinate reference system, the British National Grid.

[SMI index data at LSOA level 2011](https://pldr.org/dataset/2noyv/small-area-mental-health-index-samhi)

-   The SAMHI is a composite annual measure of population mental health for each Lower Super Output Area (LSOA) in England. The SAMHI combines data on mental health from multiple sources (NHS-Mental health related hospital attendances, Prescribing data -- Antidepressants, QOF - depression, and DWP - Incapacity benefit and Employment support allowance for mental illness) into a single index.
-   The SAMHI index contains 2011-2019 data based on LSOA level in all England
- We use SAMHI_dec 

[Population Density Data 2011 Census](_)

-   This data based on the 2011 Census and we choose LSOA
-   We will choose these columns:
    -   geography_code
    -   area_population_density_density_number_of_persons_per_hectare_measures_value

### LSOA boundary data

```{r LSOA boundary}
lsoa <- st_read(here::here("data", "statistical-gis-boundaries-london","ESRI", "LSOA_2011_London_gen_MHW.shp")) %>%
  st_transform(., 27700)

summary(lsoa)

qtm(lsoa)
```

There are 4835 LSOA in London in 2011.

### SMI index data

```{r SAMHI index}
samhi_index <- read_csv(here::here("data","samhi_21_01_v4.00_2011_2019_LSOA_tall.csv"),locale=locale(encoding = "latin1")) %>%
  clean_names()
```

```{r}
# filter 2019 and SAMHI index column
samhi_2011 <- samhi_index %>%
  select(lsoa11,year,samhi_dec)%>%
  filter(str_detect(year, "2011"))

summary(samhi_2011)
```

```{r}
# join SAMHI index to LSOA boundary
samhi <- lsoa %>%
  left_join(.,
            samhi_2011, 
            by = c("LSOA11CD" = "lsoa11"))

Datatypelist <- samhi %>% 
  st_drop_geometry() %>%
  summarise_all(class) %>%
  pivot_longer(everything(), 
               names_to="All_variables", 
               values_to="Variable_class")

# plot SAMHI index (deciles)
#qtm(samhi, 
#    fill = "samhi_dec",
#    fill.palette = "Blues")
```

### Population Density Data

```{r pop_density}
pd <- read_csv(here::here("data","population_density.csv"),locale=locale(encoding = "latin1"))%>%
  clean_names()
```

```{r}
# filter 2011 and population density column
pd_2011 <- pd %>%
  select(geography_code, area_population_density_density_number_of_persons_per_hectare_measures_value)

summary(pd_2011)
```

### Socio-economic

```{r deprivation}
depriv <- read_excel(here::here("data","lsoa-data.xls"))%>%
  clean_names()

head(depriv)
```

```{r}
# filter 2011 and population density column
depriv_2011 <- depriv %>%
  select(.,codes, unemployment_rate,median_annual_household_income_estimate)%>%
  rename(annual_income=median_annual_household_income_estimate)

summary(depriv_2011)
```

### Household
```{r}
hc <- read_csv(here::here("data","household.csv"),locale=locale(encoding = "latin1")) %>%
  clean_names()
```

```{r}
hc <- read_csv(here::here("data","household.csv"),locale=locale(encoding = "latin1")) %>%
  clean_names()
```

```{r}
hc_2011 <- hc%>%
  mutate(single_hc=household_composition_one_person_household_measures_value/household_composition_all_categories_household_composition_measures_value)%>%
  select(geography_code, single_hc)
```

```{r}
sum(is.na(hc$household_composition_one_person_household_measures_value))
```
```{r}
sum(is.na(hc$household_composition_all_categories_household_composition_measures_value))
```
### Predictors

```{r}
# join population density, IMD, and ethnicity to LSOA boundary
predictors <- lsoa %>%
  left_join(.,
            samhi_2011, 
            by = c("LSOA11CD"="lsoa11"))%>%
  left_join(.,
            pd_2011, 
            by = c("LSOA11CD"="geography_code"))%>%
  left_join(.,
            depriv_2011, 
            by = c("LSOA11CD"="codes"))%>%
  left_join(.,
            hc_2011, 
            by = c("LSOA11CD"="geography_code"))
```

```{r}
# join population density, IMD, and ethnicity to LSOA boundary
predictors <- samhi_2011 %>%
  left_join(.,
            pd_2011, 
            by = c("lsoa11"="geography_code"))%>%
  left_join(.,
            depriv_2011, 
            by = c("lsoa11"="codes"))%>%
  left_join(.,
            hc_2011, 
            by = c("lsoa11"="geography_code"))
```

```{r}
write.csv(df, file='./data.csv')
```

```{r}
# join population density, IMD, and ethnicity to LSOA boundary
join <- lsoa %>%
  left_join(.,
            samhi_2011, 
            by = c("LSOA11CD"="lsoa11"))%>%
  left_join(.,
            pd_2011, 
            by = c("LSOA11CD"="geography_code"))%>%
  left_join(.,
            depriv_2011, 
            by = c("LSOA11CD"="codes"))%>%
  left_join(.,
            hc_2011, 
            by = c("LSOA11CD"="geography_code"))
```

```{r}
df <- join%>%
  select(.,LSOA11CD, samhi_dec, area_population_density_density_number_of_persons_per_hectare_measures_value, unemployment_rate, annual_income, single_hc)%>%
  rename(pop_dens=area_population_density_density_number_of_persons_per_hectare_measures_value)%>%
  clean_names()
```

```{r}
Datatypelist <- df %>% 
  st_drop_geometry() %>%
  summarise_all(class) %>%
  pivot_longer(everything(), 
               names_to="All_variables", 
               values_to="Variable_class")
```

```{r}
h1 <- ggplot(df, aes(x=pop_dens)) +
  geom_histogram(color = "darkblue",
                 fill = "lightblue") +
  theme_bw()

h2 <- ggplot(df, aes(x=unemployment_rate)) +
  geom_histogram(color = "darkblue",
                 fill = "lightblue") +
  theme_bw()

h3 <- ggplot(df, aes(x=single_hc)) +
  geom_histogram(color = "darkblue",
                 fill = "lightblue") +
  theme_bw()

h4 <- ggplot(df, aes(x=annual_income)) +
  geom_histogram(color = "darkblue",
                 fill = "lightblue") +
  theme_bw()

plot_grid(h1,h2,h3,h4)
```

Most of the variables appear normally distributed, except for population density.

## Multiple Linear Regression

### Check for the Multicollinearity

```{r multicollinearity all}
# check their correlations are OK
# pearson correlation is only appropriate for interval or ratio data
# we are only concerned about multicollinearity between predictor variables
myvars <- df %>%
  dplyr::select(samhi_dec,pop_dens,unemployment_rate,single_hc,annual_income) %>%
  st_drop_geometry()

# get correlation matrix
cormat <- cor(myvars, use="complete.obs", method="pearson")

# significance test
sig1 <- corrplot::cor.mtest(myvars, conf.level = .95)

# create a correlogram
corrplot::corrplot(cormat, type = "lower",
                   method = "circle", 
                   order = "hclust", 
                   tl.cex = 0.7,
                   p.mat = sig1$p, sig.level = .05, 
                   col = viridis::viridis(100, option = "magma"),
                   diag = FALSE)
```

The size of the circle reflects the strength of the relationships as captured by the Pearson correlation coefficient. Crosses indicate statistically insignificant relationships at the 95% level of confidence. 

It looks like pop_dens is highly correlated with imd_score and less correlated with samhi_dec, so we will remove pop_dens as a predictor variable.

```{r multicollinearity selected}
myvars2 <- myvars %>%
  select(samhi_dec,unemployment_rate,pop_dens,single_hc)

cormat <- cor(myvars2, use="complete.obs", method="pearson")

# significance test
sig1 <- corrplot::cor.mtest(myvars2, conf.level = .95)

# create a correlogram
corrplot::corrplot(cormat, type="lower",
                   method = "circle", 
                   order = "original", 
                   tl.cex = 0.7,
                   p.mat = sig1$p, sig.level = .05, 
                   col = viridis::viridis(100, option = "plasma"),
                   diag = FALSE)
```

The remaining variables no longer exhibit strong multicollinearity, so I will refine my hypothesis as follows: 

* **Hypothesis:** Higher unemployment rate, population density and single person household lead to higher mental health illness

### Check for linear relationship between x and y

```{r linear relationship}
regression_data <- df %>%
  dplyr::select(lsoa11cd,
                samhi_dec,
                unemployment_rate,
                pop_dens,
                single_hc)

p1 <- ggplot(regression_data, aes(x=pop_dens, y=samhi_dec)) + 
  geom_point() +
  geom_smooth(method=lm) +
  theme_classic()

p2 <- ggplot(regression_data, aes(x=single_hc, y=samhi_dec)) + 
  geom_point() +
  geom_smooth(method=lm) +
  theme_classic()

p3 <- ggplot(regression_data, aes(x=unemployment_rate, y=samhi_dec)) + 
  geom_point() +
  geom_smooth(method=lm) +
  theme_classic()

plot_grid(p1, p2,p3)
```

There seems to be a slight positive relationship between all our predictor variables and the percentage of obesity in the population.

### Linear model
Now I will fit a linear model using the ordinary least squares method. 

```{r lm}
eq <- samhi_dec ~
  single_hc + pop_dens + unemployment_rate

ols_model <- lm(eq,
                data = regression_data)

# show the summary of those outputs
tidy(ols_model)
glance(ols_model)
summary(ols_model)
```

Result:
Adjusted R-squared = 32.6%

p-values:
imd_score= 1.007509e-223
single_hc= 5.163738e-173

The results indicate that 36% of the variation in the mental health index can be explained by the deprivation score and average single household. The individual p-values for all predictor variables are significant at the 99.9% level of significance.

```{r}
# plot population density
map_samhi <- tm_shape(predictors)+
  tm_fill(col="samhi_dec", 
          title = "London Common Mental Health index 2011",
          style = "cont",
          textNA = "No data",
          colorNA = "white", 
          palette = "RdBu")+
  tm_borders(col = "gray", lwd = .1) +
  tm_compass(type = "arrow", position = c("right", "top") , size = .5) +
  tm_scale_bar(breaks = c(0,1,2), text.size = 0.7, position =  c("left", "bottom")) +
  tm_layout(bg.color = "white", legend.outside = TRUE)
map_samhi
```

```{r}
# plot population density
map_pd <- tm_shape(predictors)+
  tm_fill(col="imd_score", 
          title = "London Deprivation Index 2011",
          style = "cont",
          textNA = "No data",
          colorNA = "white", 
          palette = "RdBu")+
  tm_borders(col = "gray", lwd = .1) +
  tm_compass(type = "arrow", position = c("right", "top") , size = .5) +
  tm_scale_bar(breaks = c(0,1,2), text.size = 0.7, position =  c("left", "bottom")) +
  tm_layout(bg.color = "white", legend.outside = TRUE)
map_pd
```

```{r}
# plot deprivation index (IMD)
map_imd <- tm_shape(predictors)+
  tm_fill(col="area_population_density_density_number_of_persons_per_hectare_measures_value", 
          title = "London Deprivation Index 2011",
          breaks = c(0, 10 ,20, 30, 40, 50, 60,70),
          style = "fixed",
          textNA = "No data",
          colorNA = "white", 
          palette = "RdBu")+
  tm_borders(col = "gray", lwd = .1) +
  tm_compass(type = "arrow", position = c("right", "top") , size = .5) +
  tm_scale_bar(breaks = c(0,1,2), text.size = 0.7, position =  c("left", "bottom")) +
  tm_layout(bg.color = "white", legend.outside = TRUE)
map_imd
```